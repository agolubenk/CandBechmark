{% extends 'base.html' %}

{% block title %}Список вакансий{% endblock %}

{% block content %}
<div class="d-flex flex-column vh-100">
  <!-- Фиксированная верхняя секция с заголовком и поиском -->
  <div class="header-container mt-2">
    <div class="row align-items-center">
      <div class="col-md-4 mb-3 mb-md-0">
        <h1 class="mb-0">Список вакансий</h1>
      </div>
      <div class="col-md-8">
        <div class="d-flex gap-2">
          <form method="GET" action="{% url 'index' %}" class="d-flex gap-2 flex-grow-1">
            <input type="text" 
                   name="search" 
                   class="form-control" 
                   placeholder="Поиск по вакансиям..." 
                   value="{{ request.GET.search }}">
            <button type="submit" class="btn btn-primary">Поиск</button>
          </form>
          <!-- Кнопка AI-анализа -->
          <button type="button" 
                  class="btn btn-success ai-analyze-btn" 
                  data-bs-toggle="modal" 
                  data-bs-target="#aiAnalysisModal">
            <i class="bi bi-robot"></i> AI-анализ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно для AI-анализа -->
  <div class="modal fade" id="aiAnalysisModal" tabindex="-1" aria-labelledby="aiAnalysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aiAnalysisModalLabel">
            <i class="bi bi-robot"></i> AI-анализ вакансий
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Секция с текущими фильтрами -->
          <div class="current-filters mb-3">
            <h6>Текущие фильтры:</h6>
            <div class="filter-tags" id="filterTags">
              <!-- Теги фильтров будут добавляться динамически -->
            </div>
          </div>

          <!-- Секция с промптом -->
          <div class="prompt-section mb-3">
            <h6>Выберите тип анализа:</h6>
            <select class="form-select mb-2" id="promptSelect">
              <option value="salary">Анализ зарплат и тенденций</option>
              <option value="skills">Анализ требуемых навыков</option>
              <option value="companies">Анализ компаний и их предложений</option>
              <option value="locations">Анализ географического распределения</option>
              <option value="custom">Пользовательский запрос</option>
            </select>
            <div class="custom-prompt-container d-none">
              <textarea class="form-control" 
                        id="customPrompt" 
                        rows="3" 
                        placeholder="Введите ваш запрос для анализа..."></textarea>
            </div>
          </div>

          <!-- Чат с результатами -->
          <div class="chat-container mb-3">
            <div class="chat-messages" id="chatMessages">
              <!-- Сообщения будут добавляться динамически -->
              <div class="message system-message">
                Выберите тип анализа и нажмите "Начать анализ" для получения результатов.
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="startAnalysis">
            <i class="bi bi-play-fill"></i> Начать анализ
          </button>
          <button type="button" class="btn btn-success" id="downloadAnalysis" disabled>
            <i class="bi bi-file-pdf"></i> Скачать HTML
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Контейнер с таблицей -->
  <div class="table-container">
    <!-- Фиксированный заголовок таблицы -->
    <div class="fixed-header">
      <table class="table table-bordered mb-0">
        <thead class="table-light">
          <tr>
            <th>Компания</th>
            <th>Локация</th>
            <th>Специализация</th>
            <th>Грейд</th>
            <th>ЗП от</th>
            <th>ЗП до</th>
            <th>Валюта</th>
            <th>Действие</th>
          </tr>
        </thead>
      </table>
    </div>
    
    <!-- Скроллируемое тело таблицы -->
    <div class="table-scroll">
      <table class="table table-bordered table-hover mb-0">
        <tbody>
          {% for vac in vacancies %}
          <tr>
            <td>{{ vac.company }}</td>
            <td>{{ vac.geo }}</td>
            <td>{{ vac.specialization }}</td>
            <td>{{ vac.grade }}</td>
            <td>{{ vac.salary_min }}</td>
            <td>{{ vac.salary_max }}</td>
            <td>{{ vac.currency }}</td>
            <td>
              <a href="{% url 'vacancy_detail' vac.id %}" class="btn btn-outline-info btn-sm">
                <i class="bi bi-eye-fill"></i> Info
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center">Нет вакансий для отображения.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Фиксированная пагинация внизу -->
  {% if vacancies.has_other_pages %}
  <div class="pagination-container">
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center mb-0">
        {% if vacancies.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ vacancies.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">&laquo;</a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">&laquo;</span>
          </li>
        {% endif %}

        <!-- Первая страница всегда видна -->
        {% if vacancies.number > 3 %}
          <li class="page-item">
            <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">1</a>
          </li>
          {% if vacancies.number > 4 %}
            <li class="page-item disabled d-none d-md-block">
              <span class="page-link">...</span>
            </li>
          {% endif %}
        {% endif %}

        {% for i in vacancies.paginator.page_range %}
          {% if i > vacancies.number|add:'-3' and i < vacancies.number|add:'3' %}
            {% if vacancies.number == i %}
              <li class="page-item active">
                <span class="page-link">{{ i }}</span>
              </li>
            {% else %}
              <li class="page-item">
                <a class="page-link" href="?page={{ i }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">{{ i }}</a>
              </li>
            {% endif %}
          {% endif %}
        {% endfor %}

        <!-- Последняя страница всегда видна -->
        {% if vacancies.number < vacancies.paginator.num_pages|add:'-2' %}
          {% if vacancies.number < vacancies.paginator.num_pages|add:'-3' %}
            <li class="page-item disabled d-none d-md-block">
              <span class="page-link">...</span>
            </li>
          {% endif %}
          <li class="page-item">
            <a class="page-link" href="?page={{ vacancies.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">{{ vacancies.paginator.num_pages }}</a>
          </li>
        {% endif %}

        {% if vacancies.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ vacancies.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">&raquo;</a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">&raquo;</span>
          </li>
        {% endif %}
      </ul>
    </nav>
  </div>
  {% endif %}
</div>

<style>
  /* Стили для фиксированной верхней секции */
  .header-container {
    position: fixed;
    top: 56px;
    left: 0;
    right: 0;
    background: white;
    padding: 0.25rem 1rem;
    z-index: 1000;
    border-bottom: 1px solid #dee2e6;
  }
  /* Стили для контейнера таблицы */
  .table-container {
    margin-top: 40px;
    padding-bottom: 45px;
    position: relative;
    height: calc(100vh - 101px);
  }

  .fixed-header {
    position: sticky;
    top: 40px;
    background: white;
    z-index: 999;
    border-bottom: 1px solid #dee2e6;
  }

  .table-scroll {
    overflow-y: auto;
    height: calc(100% - 42px); /* высота контейнера минус высота заголовка */
  }

  /* Выравнивание ширины колонок */
  .fixed-header table,
  .table-scroll table {
    table-layout: fixed;
    width: 100%;
  }

  .fixed-header th,
  .table-scroll td {
    width: 12.5%; /* 100% / 8 колонок */
  }

  /* Убираем двойную рамку между заголовком и телом */
  .table-scroll .table {
    border-top: none;
  }

  .table-scroll .table tbody tr:first-child td {
    border-top: none;
  }

  /* Медиа-запрос для мобильных устройств */
  @media (max-width: 768px) {
    .header-container {
      padding: 0.25rem 1rem;
    }

    .fixed-header {
      top: 70px;
    }
  }

  /* Стили для пагинации */
  .pagination-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 0.5rem;
    border-top: 1px solid #dee2e6;
    z-index: 1000;
  }

  .table {
    margin-bottom: 0;
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  /* Обновленные стили для пагинации */
  .pagination {
    margin-bottom: 0;
    flex-wrap: nowrap;
  }

  .page-link {
    padding: 0.375rem 0.75rem;
  }

  @media (max-width: 768px) {
    .pagination .page-link {
      padding: 0.375rem 0.5rem;
    }

    /* Уменьшаем отступы в пагинации на мобильных */
    .pagination-container {
      padding: 0.25rem;
    }
  }

  /* Стили для AI-анализа */
  .ai-analyze-btn {
    white-space: nowrap;
    transition: all 0.3s ease;
  }

  .ai-analyze-btn:hover {
    transform: scale(1.05);
  }

  .filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .filter-tag {
    background-color: #e9ecef;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
  }

  .chat-container {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    height: 300px;
    overflow-y: auto;
  }

  .chat-messages {
    padding: 1rem;
  }

  .message {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: 0.375rem;
    max-width: 80%;
  }

  .system-message {
    background-color: #f8f9fa;
    margin-left: auto;
    margin-right: auto;
    text-align: center;
  }

  .user-message {
    background-color: #e9ecef;
    margin-left: auto;
  }

  .ai-message {
    background-color: #f0f9ff;
    margin-right: auto;
  }

  .message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }

  /* Анимация загрузки */
  .loading-dots::after {
    content: '';
    animation: loading 1.5s infinite;
  }

  @keyframes loading {
    0% { content: ''; }
    25% { content: '.'; }
    50% { content: '..'; }
    75% { content: '...'; }
    100% { content: ''; }
  }
</style>

{% block extra_js %}
<!-- Удаляем библиотеку jsPDF, так как она больше не нужна -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const promptSelect = document.getElementById('promptSelect');
    const customPromptContainer = document.querySelector('.custom-prompt-container');
    const chatMessages = document.getElementById('chatMessages');
    const startAnalysisBtn = document.getElementById('startAnalysis');
    const downloadAnalysisBtn = document.getElementById('downloadAnalysis');
    const filterTags = document.getElementById('filterTags');
    
    // Обработка выбора типа промпта
    promptSelect.addEventListener('change', function() {
        customPromptContainer.classList.toggle('d-none', this.value !== 'custom');
    });

    // Обновление тегов фильтров при открытии модального окна
    document.getElementById('aiAnalysisModal').addEventListener('show.bs.modal', function() {
        updateFilterTags();
    });

    // Функция обновления тегов фильтров
    function updateFilterTags() {
        const searchQuery = document.querySelector('input[name="search"]').value;
        filterTags.innerHTML = '';
        
        if (searchQuery) {
            const tag = document.createElement('span');
            tag.className = 'filter-tag';
            tag.textContent = `Поиск: ${searchQuery}`;
            filterTags.appendChild(tag);
        } else {
            const tag = document.createElement('span');
            tag.className = 'filter-tag';
            tag.textContent = 'Все вакансии';
            filterTags.appendChild(tag);
        }
    }

    // Функция добавления сообщения в чат
    function addMessage(text, type = 'system') {
        const message = document.createElement('div');
        message.className = `message ${type}-message`;
        
        const content = document.createElement('div');
        content.className = 'message-content';
        content.textContent = text;
        
        const time = document.createElement('div');
        time.className = 'message-time';
        time.textContent = new Date().toLocaleTimeString();
        
        message.appendChild(content);
        message.appendChild(time);
        chatMessages.appendChild(message);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Имитация анализа
    startAnalysisBtn.addEventListener('click', async function() {
        const promptType = promptSelect.value;
        const customPrompt = document.getElementById('customPrompt')?.value;
        
        // Добавляем сообщение пользователя
        const userPrompt = promptType === 'custom' ? 
            customPrompt : 
            `Анализ вакансий: ${promptSelect.options[promptSelect.selectedIndex].text}`;
        addMessage(userPrompt, 'user');
        
        // Добавляем сообщение о загрузке
        addMessage('Анализирую данные...', 'system');
        startAnalysisBtn.disabled = true;
        
        // Имитация задержки анализа
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Удаляем сообщение о загрузке
        chatMessages.removeChild(chatMessages.lastChild);
        
        // Добавляем ответ AI
        const aiResponse = getAIResponse(promptType);
        addMessage(aiResponse, 'ai');
        
        // Активируем кнопку скачивания
        downloadAnalysisBtn.disabled = false;
        startAnalysisBtn.disabled = false;
    });

    // Функция получения фиктивного ответа AI
    function getAIResponse(promptType) {
        const responses = {
            salary: 'На основе анализа данных о зарплатах:\n- Средняя зарплата: 3500 BYN\n- Тренд: рост на 15% за последний квартал\n- Самые высокие зарплаты в сфере: Data Engineering',
            skills: 'Наиболее востребованные навыки:\n1. Python (80% вакансий)\n2. SQL (75% вакансий)\n3. Machine Learning (45% вакансий)\n4. Big Data (30% вакансий)',
            companies: 'Анализ компаний показывает:\n- Топ-3 по количеству вакансий: Company A, Company B, Company C\n- 60% компаний предлагают удаленную работу\n- 40% предлагают релокацию',
            locations: 'Географическое распределение вакансий:\n- Минск: 45%\n- Москва: 25%\n- Варшава: 15%\n- Другие города: 15%',
            custom: 'Анализ по вашему запросу выполнен. Основные выводы:\n- Пункт 1\n- Пункт 2\n- Пункт 3'
        };
        return responses[promptType] || 'Анализ выполнен успешно.';
    }

    // Новая функция скачивания HTML
    downloadAnalysisBtn.addEventListener('click', function() {
        try {
            console.log('Starting HTML generation...');
            
            // Получаем текущую дату и время
            const now = new Date();
            const dateStr = now.toLocaleString('ru-RU');
            
            // Получаем текущие фильтры
            const filterTag = document.querySelector('.filter-tag');
            const filterText = filterTag ? filterTag.textContent : 'Все вакансии';
            
            // Создаем HTML контент
            let htmlContent = `
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализ вакансий - ${dateStr}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .header {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .filters {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .chat {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            max-width: 80%;
        }
        .system-message {
            background-color: #f8f9fa;
            margin: 20px auto;
            text-align: center;
        }
        .user-message {
            background-color: #e9ecef;
            margin-left: auto;
        }
        .ai-message {
            background-color: #f0f9ff;
            margin-right: auto;
        }
        .message-time {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
            color: #6c757d;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Анализ вакансий</h1>
        <p>Дата создания: ${dateStr}</p>
        <div class="filters">
            ${filterText}
        </div>
    </div>
    <div class="chat">`;

            // Добавляем сообщения
            const messages = Array.from(chatMessages.children);
            messages.forEach(msg => {
                const content = msg.querySelector('.message-content')?.textContent || '';
                const time = msg.querySelector('.message-time')?.textContent || '';
                let type = 'system';
                
                if (msg.classList.contains('user-message')) type = 'user';
                else if (msg.classList.contains('ai-message')) type = 'ai';
                
                htmlContent += `
        <div class="message ${type}-message">
            <pre>${content}</pre>
            <div class="message-time">${time}</div>
        </div>`;
            });

            // Добавляем подвал
            htmlContent += `
    </div>
    <div class="footer">
        <p>Сгенерировано системой AI Analysis</p>
    </div>
</body>
</html>`;

            // Создаем и скачиваем файл
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const fileName = `ai-analysis-${now.toISOString().split('T')[0]}.html`;
            
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('HTML saved successfully');
            
        } catch (error) {
            console.error('Error generating HTML:', error);
            alert('Произошла ошибка при создании отчета. Пожалуйста, попробуйте еще раз.');
        }
    });
});
</script>
{% endblock %}
{% endblock %}