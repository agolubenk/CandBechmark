{% extends 'base.html' %}

{% load static  %}

{% block title %}Список вакансий{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'flatpickr/flatpickr.min.css' %}">
<style>
  /* Стили для фиксированной верхней секции */
  .header-container {
    position: fixed;
    top: 56px;
    left: 0;
    right: 0;
    background: white;
    padding: 0.25rem 1rem;
    z-index: 1000;
    border-bottom: 1px solid #dee2e6;
  }
  /* Стили для контейнера таблицы */
  .table-container {
    margin-top: 40px;
    padding-bottom: 45px;
    position: relative;
    height: calc(100vh - 101px);
  }

  .fixed-header {
    position: sticky;
    top: 40px;
    background: white;
    z-index: 999;
    border-bottom: 1px solid #dee2e6;
  }

  .table-scroll {
    overflow-y: auto;
    height: calc(100% - 42px); /* высота контейнера минус высота заголовка */
  }

  /* Выравнивание ширины колонок */
  .fixed-header table,
  .table-scroll table {
    table-layout: fixed;
    width: 100%;
  }

  .fixed-header th,
  .table-scroll td {
    width: 12.5%; /* 100% / 8 колонок */
  }

  /* Убираем двойную рамку между заголовком и телом */
  .table-scroll .table {
    border-top: none;
  }

  .table-scroll .table tbody tr:first-child td {
    border-top: none;
  }

  /* Медиа-запрос для мобильных устройств */
  @media (max-width: 768px) {
    .header-container {
      padding: 0.25rem 1rem;
    }

    .fixed-header {
      top: 70px;
    }
  }

  /* Стили для пагинации */
  .pagination-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 0.5rem;
    border-top: 1px solid #dee2e6;
    z-index: 1000;
  }

  .table {
    margin-bottom: 0;
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  /* Обновленные стили для пагинации */
  .pagination {
    margin-bottom: 0;
    flex-wrap: nowrap;
  }

  .page-link {
    padding: 0.375rem 0.75rem;
  }

  @media (max-width: 768px) {
    .pagination .page-link {
      padding: 0.375rem 0.5rem;
    }

    /* Уменьшаем отступы в пагинации на мобильных */
    .pagination-container {
      padding: 0.25rem;
    }
  }

  /* Стили для AI-анализа */
  .ai-analyze-btn {
    white-space: nowrap;
    transition: all 0.3s ease;
  }

  .ai-analyze-btn:hover {
    transform: scale(1.05);
  }

  .filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .filter-tag {
    background-color: #e9ecef;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .filter-tag .remove-filter {
    background: none;
    border: none;
    padding: 0;
    color: #6c757d;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
    transition: color 0.2s ease;
  }

  .filter-tag .remove-filter:hover {
    color: #dc3545;
  }

  /* Обновленные стили для чата */
  .chat-container {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    height: 300px;
    display: flex;
    flex-direction: column;
    background-color: #f8f9fa;
  }

  .chat-messages {
    padding: 1rem;
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .message {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    max-width: 85%;
    padding: 0.75rem;
    border-radius: 0.5rem;
    position: relative;
  }

  .message-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .message-content {
    flex-grow: 1;
    white-space: pre-line;
  }

  .message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
    text-align: right;
  }

  .user-message {
    background-color: #e3f2fd;
    margin-left: auto;
    border-bottom-right-radius: 0.25rem;
  }

  .user-message .message-icon {
    background-color: #2196f3;
    color: white;
  }

  .system-message {
    background-color: #fff3e0;
    margin-right: auto;
    border-bottom-left-radius: 0.25rem;
  }

  .system-message .message-icon {
    background-color: #ff9800;
    color: white;
  }

  .ai-message {
    background-color: #f5f5f5;
    margin-right: auto;
    border-bottom-left-radius: 0.25rem;
  }

  .ai-message .message-icon {
    background-color: #4caf50;
    color: white;
  }

  .chat-input-container {
    padding: 0.75rem;
    border-top: 1px solid #dee2e6;
    background-color: #f8f9fa;
  }

  .chat-input-container form {
    margin: 0;
  }

  .chat-input-container .btn {
    padding: 0.375rem 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chat-input-container .btn i {
    font-size: 1rem;
  }

  #messageInput {
    border-radius: 1.5rem;
    padding: 0.375rem 1rem;
  }

  /* Убираем отступы у модального футера */
  .modal-footer {
    display: none;
  }

  /* Обновленные стили для секции промпта */
  .prompt-section select {
    flex-grow: 1;
  }

  .prompt-section .btn {
    white-space: nowrap;
  }

  /* Стили для анимации появления чата */
  .chat-container {
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
  }

  .chat-container.show {
    opacity: 1;
    transform: translateY(0);
  }

  /* Стили для кнопки скачивания */
  .download-btn {
    padding: 0.375rem 0.75rem;
    position: relative;
  }

  .download-btn::after {
    content: 'Выгрузить чат';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    margin-bottom: 5px;
  }

  .download-btn:hover::after {
    opacity: 1;
    visibility: visible;
  }

  /* Обновленные стили для Date Range Picker */
  .date-range-picker {
    position: relative;
    min-width: 300px;
  }
  .date-range-picker .form-control {
    background-color: #fff;
    cursor: pointer;
  }
  .date-range-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    padding: 1rem;
    display: none;
    width: 100%;
  }
  .date-range-dropdown.show {
    display: block;
  }
  .date-range-option {
    padding: 0.5rem 1rem;
    cursor: pointer;
    border-radius: 0.25rem;
    transition: background-color 0.2s ease;
  }
  .date-range-option:hover {
    background-color: #f8f9fa;
  }
  .custom-range-picker {
    display: none;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #dee2e6;
    position: relative;
    z-index: 1001;
  }
  .custom-range-picker.show {
    display: block;
  }
  .flatpickr-calendar {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    z-index: 1002;
  }
  .flatpickr-day.selected {
    background: #0d6efd;
    border-color: #0d6efd;
  }
  .flatpickr-day.selected:hover {
    background: #0b5ed7;
    border-color: #0a58ca;
  }
  .flatpickr-day.inRange {
    background: rgba(13, 110, 253, 0.1);
    border-color: rgba(13, 110, 253, 0.1);
  }
  .flatpickr-day.inRange:hover {
    background: rgba(13, 110, 253, 0.2);
    border-color: rgba(13, 110, 253, 0.2);
  }

  /* Стили для кнопки скачивания Excel */
  .excel-download-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 25px;
    padding: 12px 24px;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    z-index: 1000;
    width: 200px;
  }

  .excel-download-btn.waiting {
    background-color: #98d7a9; /* Бледно-зеленый цвет */
    cursor: default;
    color: #2c5235; /* Темно-зеленый цвет для текста */
  }

  .excel-download-btn.waiting .spinner-border {
    width: 1rem;
    height: 1rem;
    margin-right: 8px;
    border-color: #2c5235; /* Цвет спиннера */
    border-right-color: transparent;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }

  .excel-download-btn.waiting {
    animation: pulse 1.5s infinite;
  }

  .excel-download-btn i {
    font-size: 20px;
  }

  @media (max-width: 768px) {
    .excel-download-btn {
      bottom: 70px;
    }
  }

  /* Стили для селектора количества записей */
  .per-page-selector {
    position: fixed;
    bottom: 80px;
    right: 20px;
    z-index: 1000;
  }

  .per-page-selector .dropdown-menu {
    bottom: 100%;
    top: auto !important;
    margin-bottom: 5px;
  }

  .per-page-selector .btn-outline-secondary {
    border-radius: 25px;
    padding: 12px 24px;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    width: 170px; /* Такая же ширина, как у кнопки Excel */
    justify-content: space-between; /* Для лучшего расположения текста и иконки */
  }

  .per-page-selector .btn-outline-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    background-color: #6c757d;
    color: white;
  }

  .per-page-selector .dropdown-item {
    padding: 8px 20px;
    cursor: pointer;
  }

  .per-page-selector .dropdown-item:hover {
    background-color: #e9ecef;
  }

  @media (max-width: 768px) {
    .per-page-selector {
      bottom: 130px; /* Отступ для мобильных устройств */
      right: 20px;
    }
  }

  /* Стили для popover подтверждения */
  .popover {
    max-width: 400px;
  }

  .popover-body {
    padding: 15px;
  }

  .popover-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    justify-content: flex-end;
  }

  .popover-message {
    margin-bottom: 10px;
    color: #495057;
    font-size: 14px;
    line-height: 1.5;
  }

  .popover-buttons .btn {
    min-width: 80px;
    font-size: 14px;
    padding: 6px 12px;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-column vh-100">
  <!-- Фиксированная верхняя секция с заголовком и поиском -->
  <div class="header-container mt-2">
    <div class="row align-items-center">
      <div class="col-md-4 mb-3 mb-md-0">
        <h1 class="mb-0">Список вакансий</h1>
      </div>
      <div class="col-md-8">
        <div class="d-flex gap-2">
          <form method="GET" action="{% url 'index' %}" class="d-flex gap-2 flex-grow-1">
            <input type="text" 
                   name="search" 
                   class="form-control" 
                   placeholder="Поиск по вакансиям..." 
                   value="{{ request.GET.search }}">
            <input type="hidden" name="per_page" value="{{ request.GET.per_page|default:'50' }}">
            <div class="date-range-picker">
              <input type="text" 
                     class="form-control" 
                     id="dateRangePicker" 
                     placeholder="Выберите период" 
                     readonly>
              <div class="date-range-dropdown">
                <div class="date-range-option" data-range="today">Сегодня</div>
                <div class="date-range-option" data-range="last-week">Последняя неделя</div>
                <div class="date-range-option" data-range="last-month">Последний месяц</div>
                <div class="date-range-option" data-range="current-month">Текущий месяц</div>
                <div class="date-range-option" data-range="last-quarter">Последний квартал</div>
                <div class="date-range-option" data-range="current-quarter">Текущий квартал</div>
                <div class="date-range-option" data-range="last-6-months">Последние полгода</div>
                <div class="date-range-option" data-range="current-year">Текущий год</div>
                <div class="date-range-option" data-range="last-year">Последний год</div>
                <div class="date-range-option" data-range="all-time">Все время</div>
                <div class="date-range-option" data-range="custom">Кастомный период</div>
              </div>
              <div class="custom-range-picker">
                <div class="row">
                  <div class="col-6">
                    <input type="text" name="date_from" class="form-control" placeholder="С" value="{{ request.GET.date_from }}">
                  </div>
                  <div class="col-6">
                    <input type="text" name="date_to" class="form-control" placeholder="По" value="{{ request.GET.date_to }}">
                  </div>
                </div>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Поиск</button>
          </form>
          <!-- Кнопка AI-анализа -->
          <button type="button" 
                  class="btn btn-success ai-analyze-btn" 
                  data-bs-toggle="modal" 
                  data-bs-target="#aiAnalysisModal">
            <i class="bi bi-robot"></i> AI-анализ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно для AI-анализа -->
  <div class="modal fade" id="aiAnalysisModal" tabindex="-1" aria-labelledby="aiAnalysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aiAnalysisModalLabel">
            <i class="bi bi-robot"></i> AI-анализ вакансий
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Секция с текущими фильтрами -->
          <div class="current-filters mb-3">
            <h6>Текущие фильтры:</h6>
            <div class="filter-tags" id="filterTags">
              <!-- Теги фильтров будут добавляться динамически -->
            </div>
          </div>

          <!-- Секция с фильтрами -->
          <div class="filters-section mb-3">
            <div class="accordion" id="filtersAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse">
                            <i class="bi bi-funnel me-2"></i>Фильтры
                        </button>
                    </h2>
                    <div id="filtersCollapse" class="accordion-collapse collapse" aria-labelledby="filtersAccordion" data-bs-parent="#filtersAccordion">
                        <div class="accordion-body">
                            <div class="filter-buttons">
                                <div class="filter-group mb-2">
                                    <label class="d-block mb-1">Локация:</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button class="btn btn-outline-primary btn-sm filter-btn" data-filter="geo" data-value="Беларусь">Беларусь</button>
                                        <button class="btn btn-outline-primary btn-sm filter-btn" data-filter="geo" data-value="Россия">Россия</button>
                                        <button class="btn btn-outline-primary btn-sm filter-btn" data-filter="geo" data-value="Польша">Польша</button>
                                        <button class="btn btn-outline-primary btn-sm filter-btn" data-filter="geo" data-value="Украина">Украина</button>
                                        <button class="btn btn-outline-primary btn-sm filter-btn" data-filter="geo" data-value="Казахстан">Казахстан</button>
                                    </div>
                                </div>
                                <div class="filter-group mb-2">
                                    <label class="d-block mb-1">Грейд:</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button class="btn btn-outline-success btn-sm filter-btn" data-filter="grade" data-value="Junior">Junior</button>
                                        <button class="btn btn-outline-success btn-sm filter-btn" data-filter="grade" data-value="Middle">Middle</button>
                                        <button class="btn btn-outline-success btn-sm filter-btn" data-filter="grade" data-value="Senior">Senior</button>
                                        <button class="btn btn-outline-success btn-sm filter-btn" data-filter="grade" data-value="Lead">Lead</button>
                                    </div>
                                </div>
                                <div class="filter-group mb-2">
                                    <label class="d-block mb-1">Валюта:</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button class="btn btn-outline-info btn-sm filter-btn" data-filter="currency" data-value="BYN">BYN</button>
                                        <button class="btn btn-outline-info btn-sm filter-btn" data-filter="currency" data-value="USD">USD</button>
                                        <button class="btn btn-outline-info btn-sm filter-btn" data-filter="currency" data-value="EUR">EUR</button>
                                        <button class="btn btn-outline-info btn-sm filter-btn" data-filter="currency" data-value="RUB">RUB</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
          </div>

          <!-- Секция с промптом -->
          <div class="prompt-section mb-3">
            <h6>Выберите тип анализа:</h6>
            <div class="d-flex gap-2 align-items-start">
                <select class="form-select" id="promptSelect">
                    <option value="salary">Анализ зарплат и тенденций</option>
                    <option value="skills">Анализ требуемых навыков</option>
                    <option value="companies">Анализ компаний и их предложений</option>
                    <option value="locations">Анализ географического распределения</option>
                    <option value="custom">Пользовательский запрос</option>
                </select>
                <button type="button" class="btn btn-primary" id="startAnalysis">
                    <i class="bi bi-play-fill"></i> Анализ
                </button>
            </div>
            <div class="custom-prompt-container d-none mt-2">
                <textarea class="form-control" 
                          id="customPrompt" 
                          rows="3" 
                          placeholder="Введите ваш запрос для анализа..."></textarea>
            </div>
          </div>

          <!-- Чат с результатами -->
          <div class="chat-container mb-3 d-none" id="chatContainer">
            <div class="chat-messages" id="chatMessages">
                <!-- Сообщения будут добавляться динамически -->
            </div>
            <!-- Форма ввода сообщения -->
            <div class="chat-input-container">
                <form id="chatForm" class="d-flex gap-2">
                    <input type="text" 
                           class="form-control" 
                           id="messageInput" 
                           placeholder="Введите сообщение..."
                           autocomplete="off">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send"></i> Отправить
                        </button>
                        <button type="button" class="btn btn-success download-btn" id="downloadAnalysis" disabled>
                            <i class="bi bi-file-pdf"></i>
                        </button>
                    </div>
                </form>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="startAnalysis">
            <i class="bi bi-play-fill"></i> Начать анализ
          </button>
          <button type="button" class="btn btn-success" id="downloadAnalysis" disabled>
            <i class="bi bi-file-pdf"></i> Скачать HTML
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Контейнер с таблицей -->
  <div class="table-container">
    <!-- Селектор количества записей и кнопка Excel -->
    <div class="per-page-selector dropup">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        Показано: {{ request.GET.per_page|default:'50' }}
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item {% if request.GET.per_page == '50' %}active{% endif %}" onclick="changePerPage('50')">50 записей</a></li>
        <li><a class="dropdown-item {% if request.GET.per_page == '100' %}active{% endif %}" onclick="changePerPage('100')">100 записей</a></li>
        <li><a class="dropdown-item {% if request.GET.per_page == '200' %}active{% endif %}" onclick="changePerPage('200')">200 записей</a></li>
        <li><a class="dropdown-item {% if request.GET.per_page == '500' %}active{% endif %}" onclick="changePerPage('500')">500 записей</a></li>
        <li><a class="dropdown-item {% if request.GET.per_page == 'all' %}active{% endif %}" onclick="changePerPage('all')">Все записи</a></li>
      </ul>
    </div>

    <!-- Фиксированный заголовок таблицы -->
    <div class="fixed-header">
      <table class="table table-bordered mb-0">
        <thead class="table-light">
          <tr>
            <th>Компания</th>
            <th>Локация</th>
            <th>Специализация</th>
            <th>Грейд</th>
            <th>ЗП от</th>
            <th>ЗП до</th>
            <th>Валюта</th>
            <th>Действие</th>
          </tr>
        </thead>
      </table>
    </div>
    
    <!-- Скроллируемое тело таблицы -->
    <div class="table-scroll">
      <table class="table table-bordered table-hover mb-0">
        <tbody>
          {% for vac in vacancies %}
          <tr>
            <td>{{ vac.company }}</td>
            <td>{{ vac.geo }}</td>
            <td>{{ vac.specialization }}</td>
            <td>{{ vac.grade }}</td>
            <td>{{ vac.salary_min }}</td>
            <td>{{ vac.salary_max }}</td>
            <td>{{ vac.currency }}</td>
            <td>
              <a href="{% url 'vacancy_detail' vac.id %}" class="btn btn-outline-info btn-sm">
                <i class="bi bi-eye-fill"></i> Info
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center">Нет вакансий для отображения.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Фиксированная пагинация внизу -->
  {% if vacancies.has_other_pages %}
  <div class="pagination-container">
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center mb-0">
        {% if vacancies.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ vacancies.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">&laquo;</a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">&laquo;</span>
          </li>
        {% endif %}

        <!-- Первая страница всегда видна -->
        {% if vacancies.number > 3 %}
          <li class="page-item">
            <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">1</a>
          </li>
          {% if vacancies.number > 4 %}
            <li class="page-item disabled d-none d-md-block">
              <span class="page-link">...</span>
            </li>
          {% endif %}
        {% endif %}

        {% for i in vacancies.paginator.page_range %}
          {% if i > vacancies.number|add:'-3' and i < vacancies.number|add:'3' %}
            {% if vacancies.number == i %}
              <li class="page-item active">
                <span class="page-link">{{ i }}</span>
              </li>
            {% else %}
              <li class="page-item">
                <a class="page-link" href="?page={{ i }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">{{ i }}</a>
              </li>
            {% endif %}
          {% endif %}
        {% endfor %}

        <!-- Последняя страница всегда видна -->
        {% if vacancies.number < vacancies.paginator.num_pages|add:'-2' %}
          {% if vacancies.number < vacancies.paginator.num_pages|add:'-3' %}
            <li class="page-item disabled d-none d-md-block">
              <span class="page-link">...</span>
            </li>
          {% endif %}
          <li class="page-item">
            <a class="page-link" href="?page={{ vacancies.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">{{ vacancies.paginator.num_pages }}</a>
          </li>
        {% endif %}

        {% if vacancies.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ vacancies.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">&raquo;</a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">&raquo;</span>
          </li>
        {% endif %}
      </ul>
    </nav>
  </div>
  {% endif %}

  <!-- Кнопка скачивания Excel с popover -->
  <button class="excel-download-btn" 
          id="downloadExcel" 
          data-bs-container="body" 
          data-bs-toggle="popover" 
          data-bs-placement="top" 
          data-bs-html="true"
          data-bs-content='
            <div class="popover-message">
                Вы выбрали необходимое кол-во страниц? Если нет, то выберите для начала количество страниц для загрузки кнопкой выше.
            </div>
            <div class="popover-buttons">
                <button type="button" class="btn btn-outline-secondary" onclick="closeExcelPopover()">Нет</button>
                <button type="button" class="btn btn-success" onclick="confirmExcelDownload()">Да, скачать</button>
            </div>
          '>
    <span class="button-content">
      <i class="bi bi-file-earmark-excel"></i>
      <span class="button-text">Скачать Excel</span>
    </span>
  </button>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'flatpickr/flatpickr.min.js' %}"></script>
<script src="{% static 'flatpickr/l10n/ru.js' %}"></script>
<!-- Добавляем библиотеку для работы с Excel -->
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация Date Range Picker
    const dateRangePicker = document.getElementById('dateRangePicker');
    const dateRangeDropdown = document.querySelector('.date-range-dropdown');
    const customRangePicker = document.querySelector('.custom-range-picker');
    const dateFromInput = document.querySelector('input[name="date_from"]');
    const dateToInput = document.querySelector('input[name="date_to"]');

    // Инициализация Flatpickr для кастомного выбора дат
    const dateFromPicker = flatpickr(dateFromInput, {
        locale: 'ru',
        dateFormat: 'Y-m-d',
        onChange: function(selectedDates) {
            // Обновляем минимальную дату для конечного календаря
            dateToPicker.set('minDate', selectedDates[0]);
            // Закрываем первый календарь и открываем второй
            dateFromPicker.close();
            dateToPicker.open();
        }
    });

    const dateToPicker = flatpickr(dateToInput, {
        locale: 'ru',
        dateFormat: 'Y-m-d',
        onChange: function(selectedDates) {
            updateDateRangeDisplay();
        }
    });

    // Функция обновления отображения выбранного диапазона дат
    function updateDateRangeDisplay() {
        if (dateFromInput.value && dateToInput.value) {
            const startDate = new Date(dateFromInput.value);
            const endDate = new Date(dateToInput.value);
            dateRangePicker.value = `${startDate.toLocaleDateString('ru-RU')} - ${endDate.toLocaleDateString('ru-RU')}`;
            customRangePicker.classList.remove('show');
            dateRangeDropdown.classList.remove('show');
        }
    }

    // Обработка клика по полю выбора даты
    dateRangePicker.addEventListener('click', function(e) {
        e.stopPropagation();
        dateRangeDropdown.classList.toggle('show');
        customRangePicker.classList.remove('show');
    });

    // Закрытие выпадающего списка при клике вне его
    document.addEventListener('click', function(e) {
        if (!dateRangePicker.contains(e.target) && !e.target.closest('.flatpickr-calendar')) {
            dateRangeDropdown.classList.remove('show');
            customRangePicker.classList.remove('show');
        }
    });

    // Обработка выбора предустановленного периода
    document.querySelectorAll('.date-range-option').forEach(option => {
        option.addEventListener('click', function() {
            const range = this.dataset.range;
            const today = new Date();
            let startDate = new Date();
            let endDate = new Date();

            switch(range) {
                case 'today':
                    break;
                case 'last-week':
                    startDate.setDate(today.getDate() - 7);
                    break;
                case 'last-month':
                    startDate.setMonth(today.getMonth() - 1);
                    break;
                case 'current-month':
                    startDate.setDate(1);
                    break;
                case 'last-quarter':
                    startDate.setMonth(today.getMonth() - 3);
                    break;
                case 'current-quarter':
                    const currentQuarter = Math.floor(today.getMonth() / 3) * 3;
                    startDate.setMonth(currentQuarter);
                    startDate.setDate(1);
                    break;
                case 'last-6-months':
                    startDate.setMonth(today.getMonth() - 6);
                    break;
                case 'current-year':
                    startDate.setMonth(0);
                    startDate.setDate(1);
                    break;
                case 'last-year':
                    startDate.setFullYear(today.getFullYear() - 1);
                    endDate.setFullYear(today.getFullYear() - 1);
                    break;
                case 'all-time':
                    startDate = new Date(0);
                    break;
                case 'custom':
                    dateRangeDropdown.classList.remove('show');
                    customRangePicker.classList.add('show');
                    // Сбрасываем ограничения дат при выборе кастомного периода
                    dateToPicker.set('minDate', null);
                    // Очищаем поля дат
                    dateFromInput.value = '';
                    dateToInput.value = '';
                    // Открываем календарь для начальной даты
                    dateFromPicker.open();
                    return;
            }

            if (range !== 'custom') {
                dateFromPicker.setDate(startDate);
                dateToPicker.setDate(endDate);
                dateRangePicker.value = `${startDate.toLocaleDateString('ru-RU')} - ${endDate.toLocaleDateString('ru-RU')}`;
                dateRangeDropdown.classList.remove('show');
                customRangePicker.classList.remove('show');
            }
        });
    });

    // Остальной JavaScript код для AI-анализа
    const promptSelect = document.getElementById('promptSelect');
    const customPromptContainer = document.querySelector('.custom-prompt-container');
    const chatMessages = document.getElementById('chatMessages');
    const startAnalysisBtn = document.getElementById('startAnalysis');
    const downloadAnalysisBtn = document.getElementById('downloadAnalysis');
    const filterTags = document.getElementById('filterTags');
    
    // Обработка выбора типа промпта
    promptSelect.addEventListener('change', function() {
        customPromptContainer.classList.toggle('d-none', this.value !== 'custom');
    });

    // Обработка фильтров
    const filterButtons = document.querySelectorAll('.filter-btn');
    const activeFilters = {
        geo: [],
        grade: [],
        currency: []
    };

    // Функция для активации/деактивации кнопок фильтров
    function toggleFilterButton(button, isActive) {
        button.classList.toggle('active', isActive);
        button.style.display = isActive ? 'none' : 'inline-block';
    }

    // Функция для обновления URL с фильтрами
    function updateUrlWithFilters() {
        const params = new URLSearchParams(window.location.search);
        
        // Сохраняем текущие параметры
        const currentPerPage = params.get('per_page') || '50';  // Если нет значения, используем 50
        const currentSearch = params.get('search');
        const currentDateFrom = params.get('date_from');
        const currentDateTo = params.get('date_to');
        
        // Очищаем параметры и добавляем фильтры
        params.delete('geo');
        params.delete('grade');
        params.delete('currency');
        
        Object.entries(activeFilters).forEach(([type, values]) => {
            if (values.length > 0) {
                params.set(type, values.join(','));
            }
        });
        
        // Восстанавливаем сохраненные параметры
        params.set('per_page', currentPerPage);  // Всегда добавляем per_page
        if (currentSearch) params.set('search', currentSearch);
        if (currentDateFrom) params.set('date_from', currentDateFrom);
        if (currentDateTo) params.set('date_to', currentDateTo);
        
        const newUrl = window.location.pathname + '?' + params.toString();
        window.history.pushState({}, '', newUrl);
    }

    // Обработка кликов по кнопкам фильтров
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const filterType = this.dataset.filter;
            const filterValue = this.dataset.value;
            
            // Активируем кнопку и скрываем её
            toggleFilterButton(this, true);
            
            // Добавляем фильтр в активные
            if (!activeFilters[filterType].includes(filterValue)) {
                activeFilters[filterType].push(filterValue);
            }
            
            // Обновляем теги фильтров
            updateFilterTags();
            // Обновляем URL
            updateUrlWithFilters();
        });
    });

    // Обновленная функция обновления тегов фильтров
    function updateFilterTags() {
        const searchQuery = document.querySelector('input[name="search"]').value;
        filterTags.innerHTML = '';
        
        // Добавляем тег поиска, если есть
        if (searchQuery) {
            const searchTag = document.createElement('span');
            searchTag.className = 'filter-tag';
            searchTag.innerHTML = `
                Поиск: ${searchQuery}
                <button class="remove-filter" data-filter="search">
                    <i class="bi bi-x"></i>
                </button>
            `;
            searchTag.querySelector('.remove-filter').addEventListener('click', function() {
                document.querySelector('input[name="search"]').value = '';
                updateFilterTags();
            });
            filterTags.appendChild(searchTag);
        }
        
        // Добавляем теги для каждого типа фильтра
        Object.entries(activeFilters).forEach(([type, values]) => {
            if (values.length > 0) {
                const filterLabel = {
                    geo: 'Локация',
                    grade: 'Грейд',
                    currency: 'Валюта'
                }[type];
                
                const tag = document.createElement('span');
                tag.className = 'filter-tag';
                tag.innerHTML = `
                    ${filterLabel}: ${values.join(', ')}
                    <button class="remove-filter" data-filter="${type}">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                
                // Добавляем обработчик для кнопки удаления
                tag.querySelector('.remove-filter').addEventListener('click', function() {
                    // Находим и активируем все кнопки с соответствующими значениями
                    const buttons = document.querySelectorAll(`.filter-btn[data-filter="${type}"]`);
                    buttons.forEach(button => {
                        toggleFilterButton(button, false);
                    });
                    
                    // Очищаем массив активных фильтров для данного типа
                    activeFilters[type] = [];
                    
                    // Обновляем отображение тегов
                    updateFilterTags();
                    // Обновляем URL
                    updateUrlWithFilters();
                });
                
                filterTags.appendChild(tag);
            }
        });
        
        // Если нет активных фильтров, показываем "Все вакансии"
        if (filterTags.children.length === 0) {
            const tag = document.createElement('span');
            tag.className = 'filter-tag';
            tag.textContent = 'Все вакансии';
            filterTags.appendChild(tag);
        }
    }

    // Инициализация фильтров из URL при загрузке страницы
    function initializeFiltersFromUrl() {
        const params = new URLSearchParams(window.location.search);
        Object.keys(activeFilters).forEach(type => {
            const values = params.get(type);
            if (values) {
                activeFilters[type] = values.split(',');
                // Скрываем соответствующие кнопки
                values.split(',').forEach(value => {
                    const button = document.querySelector(`.filter-btn[data-filter="${type}"][data-value="${value}"]`);
                    if (button) {
                        toggleFilterButton(button, true);
                    }
                });
            }
        });
        updateFilterTags();
    }

    // Инициализация фильтров при открытии модального окна
    document.getElementById('aiAnalysisModal').addEventListener('show.bs.modal', function() {
        initializeFiltersFromUrl();
    });

    // Инициализация фильтров при загрузке страницы
    initializeFiltersFromUrl();

    // Обработка формы чата
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        
        if (message) {
            // Добавляем сообщение пользователя
            addMessage(message, 'user');
            
            // Очищаем поле ввода
            messageInput.value = '';
            
            // Активируем кнопку скачивания
            downloadAnalysisBtn.disabled = false;
        }
    });
    
    // Обновляем функцию addMessage для поддержки HTML-контента
    function addMessage(text, type = 'system') {
        const message = document.createElement('div');
        message.className = `message ${type}-message`;
        
        const icon = document.createElement('div');
        icon.className = 'message-icon';
        
        // Добавляем иконку в зависимости от типа сообщения
        switch(type) {
            case 'user':
                icon.innerHTML = '<i class="bi bi-person-fill"></i>';
                break;
            case 'ai':
                icon.innerHTML = '<i class="bi bi-robot"></i>';
                break;
            default:
                icon.innerHTML = '<i class="bi bi-gear-fill"></i>';
        }
        
        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'message-content-wrapper';
        
        const content = document.createElement('div');
        content.className = 'message-content';
        content.innerHTML = text;
        
        const time = document.createElement('div');
        time.className = 'message-time';
        time.textContent = new Date().toLocaleTimeString();
        
        contentWrapper.appendChild(content);
        contentWrapper.appendChild(time);
        message.appendChild(icon);
        message.appendChild(contentWrapper);
        
        chatMessages.appendChild(message);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Обработка кнопки анализа
    startAnalysisBtn.addEventListener('click', function() {
        const promptType = promptSelect.value;
        const customPrompt = document.getElementById('customPrompt')?.value;
        
        // Добавляем сообщение пользователя
        const userPrompt = promptType === 'custom' ? 
            customPrompt : 
            `Анализ вакансий: ${promptSelect.options[promptSelect.selectedIndex].text}`;
        addMessage(userPrompt, 'user');
        
        // Показываем чат с анимацией
        const chatContainer = document.getElementById('chatContainer');
        chatContainer.classList.remove('d-none');
        setTimeout(() => chatContainer.classList.add('show'), 10);
        
        // Добавляем сообщение о загрузке
        addMessage('Анализирую данные...', 'system');
        startAnalysisBtn.disabled = true;
        
        // Имитация задержки анализа
        setTimeout(() => {
            // Удаляем сообщение о загрузке
            chatMessages.removeChild(chatMessages.lastChild);
            
            // Добавляем ответ AI
            const aiResponse = getAIResponse(promptType);
            addMessage(aiResponse, 'ai');
            
            // Активируем кнопку скачивания
            downloadAnalysisBtn.disabled = false;
            startAnalysisBtn.disabled = false;
        }, 2000);
    });
    
    // Функция получения фиктивного ответа AI
    function getAIResponse(promptType) {
        const responses = {
            salary: 'На основе анализа данных о зарплатах:\n- Средняя зарплата: 3500 BYN\n- Тренд: рост на 15% за последний квартал\n- Самые высокие зарплаты в сфере: Data Engineering',
            skills: 'Наиболее востребованные навыки:\n1. Python (80% вакансий)\n2. SQL (75% вакансий)\n3. Machine Learning (45% вакансий)\n4. Big Data (30% вакансий)',
            companies: 'Анализ компаний показывает:\n- Топ-3 по количеству вакансий: Company A, Company B, Company C\n- 60% компаний предлагают удаленную работу\n- 40% предлагают релокацию',
            locations: 'Географическое распределение вакансий:\n- Минск: 45%\n- Москва: 25%\n- Варшава: 15%\n- Другие города: 15%',
            custom: 'Анализ по вашему запросу выполнен. Основные выводы:\n- Пункт 1\n- Пункт 2\n- Пункт 3'
        };
        return responses[promptType] || 'Анализ выполнен успешно.';
    }

    // Обработка кнопки скачивания
    downloadAnalysisBtn.addEventListener('click', function() {
        // Получаем текущую дату и время
        const now = new Date();
        const dateStr = now.toLocaleDateString('ru-RU', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric' 
        });
        const timeStr = now.toLocaleTimeString('ru-RU', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });

        // Получаем активные фильтры
        const activeFiltersList = Array.from(filterTags.children)
            .filter(tag => !tag.textContent.includes('Все вакансии'))
            .map(tag => tag.textContent.trim())
            .join('\n');

        // Получаем количество отфильтрованных вакансий
        const filteredVacanciesCount = document.querySelectorAll('.table-scroll tbody tr').length;

        // Создаем HTML-документ
        const htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Анализ вакансий</title>
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        line-height: 1.6;
                        margin: 20px;
                        max-width: 800px;
                        margin: 0 auto;
                        background-color: #f8f9fa;
                    }
                    .chat-messages {
                        display: flex;
                        flex-direction: column;
                        gap: 1rem;
                    }
                    .message {
                        display: flex;
                        align-items: flex-start;
                        gap: 0.75rem;
                        max-width: 85%;
                        padding: 0.75rem;
                        border-radius: 0.5rem;
                        position: relative;
                    }
                    .message-icon {
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                    }
                    .message-content {
                        flex-grow: 1;
                        white-space: pre-line;
                    }
                    .message-time {
                        font-size: 0.75rem;
                        color: #6c757d;
                        margin-top: 0.25rem;
                        text-align: right;
                    }
                    .user-message {
                        background-color: #e3f2fd;
                        margin-left: auto;
                        border-bottom-right-radius: 0.25rem;
                    }
                    .user-message .message-icon {
                        background-color: #2196f3;
                        color: white;
                    }
                    .system-message {
                        background-color: #fff3e0;
                        margin-right: auto;
                        border-bottom-left-radius: 0.25rem;
                    }
                    .system-message .message-icon {
                        background-color: #ff9800;
                        color: white;
                    }
                    .ai-message {
                        background-color: #f5f5f5;
                        margin-right: auto;
                        border-bottom-left-radius: 0.25rem;
                    }
                    .ai-message .message-icon {
                        background-color: #4caf50;
                        color: white;
                    }
                    .message-content-wrapper {
                        flex-grow: 1;
                    }
                    h1 {
                        color: #333;
                        margin-bottom: 1rem;
                        text-align: center;
                    }
                    .bi {
                        font-size: 1.2rem;
                    }
                    .report-info {
                        background-color: #fff;
                        border: 1px solid #dee2e6;
                        border-radius: 0.5rem;
                        padding: 1rem;
                        margin-bottom: 2rem;
                    }
                    .report-info p {
                        margin: 0.5rem 0;
                    }
                    .report-info strong {
                        color: #495057;
                    }
                    .footer {
                        text-align: center;
                        margin-top: 2rem;
                        padding-top: 1rem;
                        border-top: 1px solid #dee2e6;
                        font-size: 0.875rem;
                        color: #6c757d;
                    }
                </style>
            </head>
            <body>
                <h1>Анализ вакансий</h1>
                
                <div class="report-info">
                    <p><strong>Дата:</strong> ${dateStr}</p>
                    <p><strong>Время:</strong> ${timeStr}</p>
                    <p><strong>Автор:</strong> Market Benchmark from @agolubenk</p>
                    <p><strong>Количество проанализированных вакансий:</strong> ${filteredVacanciesCount}</p>
                    ${activeFiltersList ? `<p><strong>Примененные фильтры:</strong></p><pre style="margin: 0.5rem 0; white-space: pre-wrap;">${activeFiltersList}</pre>` : ''}
                </div>

                <div class="chat-messages">
                    ${Array.from(chatMessages.children).map(message => `
                        <div class="message ${message.classList.contains('user-message') ? 'user-message' : 
                            message.classList.contains('ai-message') ? 'ai-message' : 'system-message'}">
                            <div class="message-icon">
                                ${message.querySelector('.message-icon').innerHTML}
                            </div>
                            <div class="message-content-wrapper">
                                <div class="message-content">${message.querySelector('.message-content').innerHTML}</div>
                                <div class="message-time">${message.querySelector('.message-time').textContent}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="footer">
                    <p>Сгенерировано Market Benchmark</p>
                    <p>${dateStr} ${timeStr}</p>
                </div>
            </body>
            </html>
        `;

        // Создаем Blob и ссылку для скачивания
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'анализ_вакансий.html';
        
        // Добавляем ссылку в документ, эмулируем клик и удаляем ссылку
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    });

    // Инициализация popover для кнопки Excel
    const downloadExcelBtn = document.getElementById('downloadExcel');
    
    // Инициализируем popover с настройками
    const popover = new bootstrap.Popover(downloadExcelBtn, {
        html: true,
        trigger: 'manual',
        sanitize: false
    });

    // Показываем popover при клике на кнопку
    downloadExcelBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Меняем состояние кнопки
        this.classList.add('waiting');
        const buttonContent = this.querySelector('.button-content');
        buttonContent.innerHTML = `
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <span class="button-text">Ожидаю</span>
        `;
        
        popover.show();
    });

    // Функция закрытия popover
    window.closeExcelPopover = function() {
        popover.hide();
        // Возвращаем исходное состояние кнопки
        downloadExcelBtn.classList.remove('waiting');
        const buttonContent = downloadExcelBtn.querySelector('.button-content');
        buttonContent.innerHTML = `
            <i class="bi bi-file-earmark-excel"></i>
            <span class="button-text">Скачать Excel</span>
        `;
    };

    // Закрываем popover при клике вне его
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.popover') && 
            !e.target.closest('#downloadExcel')) {
            closeExcelPopover();
        }
    });

    // Функция подтверждения и скачивания
    window.confirmExcelDownload = function() {
        // Закрываем popover
        popover.hide();
        
        // Возвращаем кнопку в исходное состояние
        downloadExcelBtn.classList.remove('waiting');
        const buttonContent = downloadExcelBtn.querySelector('.button-content');
        buttonContent.innerHTML = `
            <i class="bi bi-file-earmark-excel"></i>
            <span class="button-text">Скачать Excel</span>
        `;
        
        try {
            // Проверяем наличие таблицы и данных
            const headerElement = document.querySelector('.fixed-header thead tr');
            const bodyElement = document.querySelector('.table-scroll tbody');
            
            if (!headerElement || !bodyElement) {
                throw new Error('Не удалось найти элементы таблицы');
            }

            // Получаем заголовки таблицы
            const headers = [];
            headerElement.querySelectorAll('th').forEach((th, index) => {
                if (index < headerElement.children.length - 1) {
                    headers.push(th.textContent.trim());
                }
            });

            if (headers.length === 0) {
                throw new Error('Не удалось получить заголовки таблицы');
            }

            // Получаем данные из таблицы
            const rows = [];
            bodyElement.querySelectorAll('tr').forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach((cell, index) => {
                    if (index < row.children.length - 1) {
                        rowData.push(cell.textContent.trim());
                    }
                });
                if (rowData.length > 0) {
                    rows.push(rowData);
                }
            });

            if (rows.length === 0) {
                throw new Error('Таблица не содержит данных');
            }

            // Создаем рабочую книгу Excel
            const wb = XLSX.utils.book_new();
            
            // Создаем рабочий лист и добавляем данные
            const wsData = [headers, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Устанавливаем ширину столбцов
            ws['!cols'] = headers.map(() => ({ wch: 15 }));

            // Применяем стили к заголовкам
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const address = XLSX.utils.encode_cell({ r: 0, c: C });
                if (!ws[address]) continue;
                ws[address].s = {
                    font: { bold: true },
                    alignment: { horizontal: 'center', vertical: 'center' }
                };
            }

            // Добавляем лист в книгу
            XLSX.utils.book_append_sheet(wb, ws, "Вакансии");

            // Форматируем текущую дату для имени файла
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();

            // Сохраняем файл
            XLSX.writeFile(wb, `vacancies_${day}-${month}-${year}.xlsx`);
        } catch (error) {
            console.error('Подробная ошибка:', error);
            alert(`Произошла ошибка при создании файла: ${error.message}`);
        }
    };

    // Функция изменения количества записей на странице
    window.changePerPage = function(value) {
        const params = new URLSearchParams(window.location.search);
        params.set('per_page', value);  // Всегда устанавливаем значение
        window.location.href = window.location.pathname + '?' + params.toString();
    }
});
</script>
{% endblock %}